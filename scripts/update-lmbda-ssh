#!/usr/bin/env bash
# Update the lmbda SSH host IP from the current running Lambda instance
# Usage: ./scripts/update-lmbda-ssh [instance_id]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
SSH_CONF="$PROJECT_DIR/tmp/lmbda-ssh.conf"

# Get instance IP (either by ID or first active instance)
if [ -n "$1" ]; then
    IP=$(python -m lambda_gha.cli get "$1" 2>/dev/null | jq -r '.data.ip // empty')
else
    IP=$(python -m lambda_gha.cli ls 2>/dev/null | jq -r '.data[0].ip // empty')
fi

if [ -z "$IP" ]; then
    echo "No active Lambda instance found" >&2
    exit 1
fi

# Create tmp dir if needed
mkdir -p "$PROJECT_DIR/tmp"

# Write SSH config fragment
cat > "$SSH_CONF" <<EOF
# Auto-generated by scripts/update-lmbda-ssh
# Include this in ~/.ssh/config with: Include $SSH_CONF
Host lmbda
    HostName $IP
    User ubuntu
    IdentitiesOnly yes
    IdentityFile ~/.ssh/lambda_ecdsa
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
EOF

echo "Updated $SSH_CONF with IP: $IP"
echo "Run: ssh lmbda"
